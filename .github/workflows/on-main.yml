name: Main

on:
  push:
    branches:
      - main
jobs:
  build-and-test:
    uses: ./.github/workflows/build-and-test.yml
    secrets:
      vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
      vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}

  deploy:
    name: ðŸš€ Deploy to production
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    if: github.ref == 'refs/heads/main'
    concurrency: deployment
    environment:
      name: Production
      url: https://wentingwang.co.uk
    needs: [build-and-test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Vercel CLI
        run: yarn global add vercel

      - name: Download built project
        uses: actions/download-artifact@v3
        with:
          name: project
          path: .next

      - name: Download build output
        uses: actions/download-artifact@v3
        with:
          name: build-output
          path: .vercel/output

      - name: Deploy built project to production
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
