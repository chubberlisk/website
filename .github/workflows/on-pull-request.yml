name: Pull Request

on: pull_request

permissions:
  contents: write
  pull-requests: write

jobs:
  ci:
    name: CI
    uses: ./.github/workflows/ci.yml
    secrets:
      vercel-token: ${{ secrets.VERCEL_TOKEN }}
      vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
      vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}

  approve-and-auto-merge-dependabot-pr:
    name: âœ… Approve and auto-merge Dependabot PR
    runs-on: ubuntu-latest
    needs: ci
    if: ${{ github.event.pull_request.user.login == 'dependabot[bot]' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Fetch metadata
        id: metadata
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
      - name: Dismiss approvals
        run: |
          gh api repos/chubberlisk/website/pulls/${{ github.event.number }}/reviews --jq '.[] | \
            [.id,.state] | join("=")' | grep -Po '\d+(?=\=APPROVED)' | \
            xargs -I '@(review_id)' gh api --method PUT -H "Accept: application/vnd.github+json" \
            repos/chubberlisk/website/pulls/${{ github.event.number }}/reviews/@(review_id)/dismissals \
            -f message='Dismiss stale review.' -f event='DISMISS'
      - name: Approve and auto-merge PR for non-major version upgrades
        if: ${{ steps.metadata.outputs.update-type != 'version-update:semver-major' }}
        run: |
          gh pr checkout "$PR_URL"
          if [ "$(gh pr status --json reviewDecision -q .currentBranch.reviewDecision)" != "APPROVED" ];
          then gh pr review --approve "$PR_URL"
          fi
          gh pr merge --merge --auto "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
