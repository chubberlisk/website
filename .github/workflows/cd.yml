name: CD

on:
  workflow_call:
    secrets:
      vercel-token:
        required: true
      vercel-org-id:
        required: true
      vercel-project-id:
        required: true

jobs:
  deploy:
    name: ðŸš€ Deploy to production
    env:
      VERCEL_ORG_ID: ${{ secrets.vercel-org-id }}
      VERCEL_PROJECT_ID: ${{ secrets.vercel-project-id }}
    concurrency: deployment
    environment:
      name: Production
      url: https://wentingwang.co.uk
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: yarn global add vercel

      - name: Pull production environment information
        run: vercel pull --yes --environment=production --token=${{ secrets.vercel-token }}

      - name: Build project
        run: vercel build --prod --token=${{ secrets.vercel-token }}

      - name: Deploy built project to production
        run: vercel deploy --prebuilt --prod --token=${{ secrets.vercel-token }}

  post-deploy-smoke-testing:
    name: ðŸ–¥ Post-deploy to production smoke testing
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run smoke tests
        uses: cypress-io/github-action@v6
        with:
          command: yarn test:smoke --config-file cypress.prod.config.js
          wait-on: "https://wentingwang.co.uk/"

      - name: Upload screenshots
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots

      - name: Upload videos
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: cypress-videos
          path: cypress/videos
